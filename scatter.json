{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Crimes vs GDP trajectories by state",
  "width": 1150,
  "height": 600,

  "data": {
    "url": "https://raw.githubusercontent.com/chokhueyyan/FIT3179/refs/heads/main/Crime_Econ.csv"
  },

  "params": [
    {
      "name": "States",
      "value": null,
      "bind": {
        "input": "select",
        "name": "Select State: ",
        "options": [
          null,
          "Johor",
          "Kedah",
          "Kelantan",
          "Kuala Lumpur",
          "Melaka",
          "Negeri Sembilan",
          "Pahang",
          "Perak",
          "Perlis",
          "Pulau Pinang",
          "Sabah",
          "Sarawak",
          "Selangor",
          "Terengganu"
        ],
        "labels": [
          "All States",
          "Johor",
          "Kedah",
          "Kelantan",
          "Kuala Lumpur",
          "Melaka",
          "Negeri Sembilan",
          "Pahang",
          "Perak",
          "Perlis",
          "Pulau Pinang",
          "Sabah",
          "Sarawak",
          "Selangor",
          "Terengganu"
        ]
      }
    },
    {
      "name": "YearFrom",
      "value": 2016,
      "bind": {
        "input": "range",
        "min": 2016,
        "max": 2023,
        "step": 1,
        "name": "From year: "
      }
    }
  ],

  "transform": [
    { "calculate": "toDate(datum.date)", "as": "d" },
    { "calculate": "year(datum.d)", "as": "yr" },
    { "filter": "States == null || datum.state == States" },
    {
      "aggregate": [
        { "op": "sum", "field": "crimes", "as": "total_crimes" },
        { "op": "max", "field": "total_gdp", "as": "total_gdp" }
      ],
      "groupby": ["state", "yr"]
    }
  ],

  "encoding": {
    "color": {
      "field": "state",
      "type": "nominal",
      "legend": { "columns": 1, "title": "State", "symbolOpacity": 1 },
      "scale": {
        "domain": [
          "Johor",
          "Kedah",
          "Kelantan",
          "Kuala Lumpur",
          "Melaka",
          "Negeri Sembilan",
          "Pahang",
          "Perak",
          "Perlis",
          "Pulau Pinang",
          "Sabah",
          "Sarawak",
          "Selangor",
          "Terengganu"
        ],
        "range": [
          "#8dd3c7",
          "#b15928",
          "#bebada",
          "#fb8072",
          "#80b1d3",
          "#fdb462",
          "#b3de69",
          "#fccde5",
          "#bc80bd",
          "#ccebc5",
          "#ffed6f",
          "#8c96c6",
          "#1b9e77",
          "#e7298a"
        ]
      }
    }
  },

  "layer": [
    {
      "transform": [{ "filter": "datum.yr >= YearFrom" }],
      "mark": { "type": "line" },
      "encoding": {
        "x": {
          "field": "total_crimes",
          "type": "quantitative",
          "axis": { "format": ",.0f" }
        },
        "y": {
          "field": "total_gdp",
          "type": "quantitative",
          "axis": { "format": ",.0f" }
        },
        "detail": { "field": "state" }
      }
    },
    {
      "transform": [{ "filter": "datum.yr >= YearFrom" }],

      "mark": {
        "type": "point",
        "filled": true,
        "size": 120,
        "stroke": "white",
        "strokeWidth": 0.6
      },
      "encoding": {
        "x": {
          "field": "total_crimes",
          "type": "quantitative",
          "title": "Total Crimes"
        },
        "y": {
          "field": "total_gdp",
          "type": "quantitative",
          "title": "Total GDP (RM Million)"
        },
        "tooltip": [
          { "field": "state", "title": "State" },
          { "field": "yr", "title": "Year" },
          { "field": "total_crimes", "title": "Total Crimes", "format": "," },
          {
            "field": "total_gdp",
            "title": "Total GDP (RM Million)",
            "format": ","
          }
        ]
      }
    },
    {
      "transform": [
        { "filter": "datum.yr >= YearFrom" },
        { "regression": "total_gdp", "on": "total_crimes" }
      ],
      "mark": {
        "type": "line",
        "stroke": "#444",
        "strokeDash": [6, 4],
        "opacity": 0.8
      },
      "encoding": {
        "x": { "field": "total_crimes", "type": "quantitative" },
        "y": { "field": "total_gdp", "type": "quantitative" }
      }
    },
   
    {
      "transform": [
        { "filter": "datum.yr >= YearFrom" },
        {
          "window": [{ "op": "row_number", "as": "rn" }],
          "sort": [{ "field": "yr", "order": "descending" }],
          "groupby": ["state"]
        },
        { "filter": "datum.rn == 1" },
        { "filter": "States != null && datum.state == States" }
      ],
      "mark": {
        "type": "text",
        "dx": 8,
        "dy": -6,
        "fontSize": 12,
        "fontWeight": "bold"
      },
      "encoding": {
        "x": { "field": "total_crimes", "type": "quantitative" },
        "y": { "field": "total_gdp", "type": "quantitative" },
        "text": { "field": "state" },
        "color": { "field": "state", "type": "nominal", "legend": null }
      }
    }
  ]
}
